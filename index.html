<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <title>Verification and Validation of MOM6</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="./reveal.js/dist/reveal.css">
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <link rel="stylesheet" href="./reveal.js/css/theme/gfdl.css" id="theme">
  <!-- Explicitly add zenburn for highlight support -->
  <link rel="stylesheet" href="./reveal.js/plugin/highlight/zenburn.css" id="theme">
  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? './reveal.js/css/print/pdf.scss' : './reveal.js/css/print/paper.scss';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>
  <!--[if lt IE 9]>
  <script src="./reveal.js/lib/js/html5shiv.js"></script>
  <![endif]-->
  <base href="./index.html">
</head>
<body>
  <div class="reveal"
       style="background: url(img/bg_gfdl.jpg);
              background-size: cover;">

    <!-- Original ratio: 10.04" x 7.08" -->
    <div style="height: 100vh; position: absolute; bottom: -50vh; left: -40vh">
      <img style="height: 100vh; width: 142vh" src="img/bg_globe.png">
    </div>

    <header style="width: 10vh; position: absolute; bottom: 2vh; right: 2vh;">
      <img src="img/noaa_logo.png">
    </header>

    <footer style="font-size: 1pc; position: absolute; bottom: 2%; left: 2%;">
      <code>https://marshallward.org/mom6vv</code>
    </footer>

    <div class="slides">

<section id="title-slide">
  <!--div class="reveal" style="text-align: right;">
    <img src="img/noaa_logo.png"
         style="background: none; border: none; box-shadow: none;
         width: 30%"
         alt="NCI">
  </div-->
  <h1 class="title">Verification and Validation of MOM6</h1>
  <p class="author" style="text-align: right;"><ul>
<li>Alistair Adcroft</li>
<li>Robert Hallberg</li>
<li><strong>Marshall Ward</strong></li>
</ul></p>
  <p class="date" style="text-align: right;">2020 June 8</p>
</section>

<section class="slide level2">

<p><strong>Verification</strong></p>
<blockquote>
<p>Am I building the product right?</p>
</blockquote>
<p><strong>Validation</strong></p>
<blockquote>
<p>Am I building the right product?</p>
</blockquote>
<p>Barry Boehm, <em>Software Risk Management</em> (1989)</p>
</section>
<section id="verification" class="title-slide slide level1">
<h1>Verification</h1>
<p>What are the <em>design specifications</em> of my model?</p>
<ul>
<li>Does it compile on target platforms?</li>
<li>Are the equations dimensionally consistent?</li>
<li>Does parallelization change the answers?</li>
</ul>
<p><em>Verification is the confirmation of design specifications.</em></p>
</section>

<section id="validation" class="title-slide slide level1">
<h1>Validation</h1>
<p>Does our model meet operational needs?</p>
<ul>
<li>Does it produce realistic simulations?</li>
<li>Are relevant physical features present?</li>
<li>Can I reproduce my old simulations?</li>
</ul>
<p><em>Validation is an assessment of the final product.</em></p>
</section>

<section id="vv-in-development" class="title-slide slide level1">
<h1>V&amp;V in Development</h1>
<table>
<tbody>
<tr class="odd">
<td><img data-src="img/waterfall.svg" title="fig:" style="width:60.0%" alt="Waterfall" /></td>
<td><img data-src="img/v_model.svg" title="fig:" alt="V-model" /></td>
</tr>
</tbody>
</table>
<figure>
<img data-src="img/agile.jpeg" style="width:50.0%" alt="" />
</figure>
<aside class="notes">
<p>All software development models rely on some form of verification or validation.</p>
<p>The waterfall method (upper left) has a single stage of development, like building a bridge or launching a space rocket, so validation is not possible. Verification must be extremely thorough.</p>
<p>More iterative models like the V-model treat the development process as verification, and then use validation to re-define the verification steps.</p>
<p>Modern Agile methods define multiple development cycles, including verification and validation after each "scrum". Scrum-like methods can blur the distinction between verification and validation.</p>
</aside>
</section>

<section id="vv-in-mom6" class="title-slide slide level1">
<h1>V&amp;V in MOM6</h1>
<p><img data-src="img/mom_submit.svg" class="float float" style="width:20.0%" alt="image" /></p>
<ul>
<li>Fork from a community repository</li>
<li>Implement feature</li>
<li>Submit as Pull Request™ (PR)</li>
<li>Trigger V&amp;V events
<ul>
<li>Automated verification</li>
<li>Manual validation</li>
</ul></li>
</ul>
<p>All contributions must pass verification and validation before merge.</p>
<aside class="notes">
<p>A contributer first creates a fork of the active development branch, say <code>dev/gfdl</code>.</p>
<p>Contributor works on their new feature. Meanwhile, <code>dev/gfdl</code> is also evolving.</p>
<p>Once completed, the contributer submits it as a Pull Request via GitHub.</p>
<p>The submission must meet the design criteria of the source code. This is satisfied by pass through verification and validation before being considered for contribution.</p>
</aside>
</section>

<section>
<section id="mom6-verification" class="title-slide slide level1">
<h1>MOM6 Verification</h1>
<p>Verification is automatically submitted to a CI (e.g. Travis)</p>
<p><img data-src="img/mom_verify.svg" style="width:50.0%" alt="image" /></p>
</section>
<section id="verification-tests" class="slide level2">
<h2>Verification Tests</h2>
<table>
<thead>
<tr class="header">
<th>Test</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>grid</td>
<td>Symmetric/Asymmetric memory grids</td>
</tr>
<tr class="even">
<td>layout</td>
<td>1×1 and 2×1 domain decomposition</td>
</tr>
<tr class="odd">
<td>rotation</td>
<td>Index rotation</td>
</tr>
<tr class="even">
<td>restart</td>
<td>Restart at mid-run</td>
</tr>
<tr class="odd">
<td>repro</td>
<td>Optimized reproducible mode</td>
</tr>
<tr class="even">
<td>openmp</td>
<td>OpenMP (single-thread)</td>
</tr>
<tr class="odd">
<td>nan</td>
<td>NaN array initialization</td>
</tr>
<tr class="even">
<td>dim</td>
<td>Dimensional scaling</td>
</tr>
</tbody>
</table>
<p>Each test requires bit reproducibility</p>
</section></section>
<section id="tests-in-action" class="title-slide slide level1">
<h1>Tests in Action</h1>
<table>
<tbody>
<tr class="odd">
<td><a href="https://travis-ci.org/github/marshallward/MOM6/jobs/687171621"><img data-src="img/travis_pass.png" alt="image" /></a></td>
<td><a href="https://travis-ci.org/github/marshallward/MOM6/jobs/687177632"><img data-src="img/travis_fail.png" alt="image" /></a></td>
</tr>
</tbody>
</table>
</section>

<section id="mom6-validation" class="title-slide slide level1">
<h1>MOM6 Validation</h1>
<p><img data-src="img/mom_validate.svg" style="width:80.0%" alt="image" /></p>
<p>Current validation includes over 60 tests</p>
<aside class="notes">
<p>This slide describes the GFDL validation process, but every center will customize its own validation process.</p>
<p>The GFDL validation process is illustrated in this diagram.</p>
<p>Only a subset of the tests are shown here, for the sake of space and readability.</p>
<p>At least five different types of executables are required, describing different states of model coupling.</p>
<p>All runs are tested on the GNU, Intel, and PGI compilers.</p>
<p>After confirming that the code can be compiled in every case, we then run over sixty tests, times the number of compilers.</p>
<p>Testing typically requires nearly a half hour over 30 compute nodes.</p>
<p>Completion of this test ensures bit reproducibility of all very wide range of production runs which are considered essential to GFDL.</p>
</aside>
</section>

<section id="hub-validation" class="title-slide slide level1">
<h1>Hub Validation</h1>
<p><img data-src="img/gitrepos.svg" class="float float" style="width:50.0%" alt="image" /></p>
<p>Local contributions accumulate over time, becoming a <code>dev/master</code> PR.</p>
<p>Local hub submits PR, and each hub validates the PR.</p>
<p>Upon consensus, PR is merged into <code>dev/master</code>.</p>
</section>

<section id="bit-reproducibility" class="title-slide slide level1">
<h1>Bit Reproducibility</h1>
<p>Verification requires bit reproducibility</p>
<figure>
<video data-src="img/pilotwings_repro.mp4" controls=""><a href="img/pilotwings_repro.mp4"></a></video><figcaption>Identical code and input, different math libraries</figcaption>
</figure>
<aside class="notes">
<p>This is two instances of the opening demo of the 1991 Super Nintendo game, "Pilotwings".</p>
<p>In the initial release, the plane would make a graceful landing. But in a later version, the plan would crash spectacularly.</p>
<p>People later inspected the data and discovered that the instruction code was identical. So what happenend?</p>
<p>The cartridge included a mathematical coprocessor (NEC DSP-1) for its 3D calculations. The second iteration of the coprocessor (DSP-1b) reordered some of its arithmetic to improve the accuracy of various calculations.</p>
<p>Unfortunately this also resulted in tiny course corrections in the flight, which eventually led to the demise of the biplane in the video.</p>
<p>The moral of the story is that when working with limited precision, one must be very careful!</p>
<p>(Confession: this was fixed-precision arithmetic, but it's basically the same problem.)</p>
</aside>
</section>

<section id="floating-point-review" class="title-slide slide level1">
<h1>Floating Point Review</h1>
<p><a href="https://commons.wikimedia.org/wiki/File:Float_example.svg"><img data-src="img/IEEE_754_Double_Floating_Point_Format.svg" alt="image" /></a></p>
<p><span class="math display">\[(-1)^s \times 1.\{\text{frac}\}\times 2^{\{\text{exp}\}}\]</span></p>
<ul>
<li>Smallest fractional diff: <span class="math inline">\(2^{-52} \approx 2.2 \times 10^{-16}\)</span></li>
<li>17 digits to uniquely specify a result</li>
<li>Two unique representations of zero: <span class="math inline">\(\pm 0\)</span></li>
</ul>
<aside class="notes">
<p>Probably old news to everyone, but just as a quick review:</p>
<p>Floating point numbers consist of three fields:</p>
<ul>
<li>A sign bit</li>
<li>A power-of-two exponent (plus an offset)</li>
<li>A fractional field (52 bits, in double precision)</li>
</ul>
<p>There are a few other considerations here, like the Inf and NaN cases, or denormal numbers, but we don't need to discuss these for now.</p>
<p>The main thing to note for now is that the smallest fractional value is 2^-52, or about 2.2 x 10^-16. This defines a threshhold for reproducibility.</p>
<p>The other thing to quickly note is that both +/-0 exist in this format, which we'll mention later.</p>
</aside>
</section>

<section id="addition-associativity" class="title-slide slide level1">
<h1>Addition Associativity</h1>
<p>What is <span class="math inline">\(10^{-16} + 1 - 1\)</span>?</p>
<p><span class="math display">\[\begin{aligned}
(10^{-16} + 1) - 1 &amp;= 0 \\
10^{-16} + (1 - 1) &amp;\equiv 10^{-16}
\end{aligned}\]</span></p>
<p>Residuals below <span class="math inline">\(2\times10^{-16}\)</span> may be lost.</p>
<aside class="notes">
<p>10^-16 is below the 2x10^-16 threshold, so is lost in the first summation.</p>
<p>Cancellation in the second summation preserves this value.</p>
</aside>
</section>

<section id="more-addition-examples" class="title-slide slide level1">
<h1>More Addition Examples</h1>
<p>Let <span class="math inline">\(s = 1 + 2 \times 10^{-16}\)</span>. What is <span class="math inline">\((s + 1) - 1\)</span>?</p>
<p><span class="math display">\[\begin{aligned}
s + 1 &amp;= 2 \\
(s + 1) - 1 &amp;= 1 \neq s
\end{aligned}\]</span></p>
<p>Manipulation of <span class="math inline">\(s\)</span> shifted the least resolvable value.</p>
<aside class="notes">
<p>The example here is making the same point as the last one, but showing that the least resolvable value can change (or "float") during a calculation.</p>
<p>Even though we can initially resolve the 2 x 10^-16 fraction, this fraction is immediately lost once we add +1 to the result, shifting the fraction.</p>
<p>So it's not enough to just look for resolvable residuals, because this "floats" to fit the value.</p>
</aside>
</section>

<section>
<section id="multiplication-associativity" class="title-slide slide level1">
<h1>Multiplication associativity</h1>
<p>If <span class="math inline">\(a = b = 1.5\)</span>, and <span class="math inline">\(c = 1 + 2^{-52}\)</span>, then</p>
<p><span class="math display">\[\begin{aligned}
(a \times b) \times c &amp;\equiv 2.25 + 2^{-51} \\
a \times (b \times c) &amp;\equiv 2.25 + 2^{-50}
\end{aligned}\]</span></p>
<p>(Actual results depend on rounding rules)</p>
<aside class="notes">
<p>Associativity of multiplication is overall less volatile, since the largest variations are handled in the exponent.</p>
<p>The fractional part can only increase the exponent, and at most only one bit is lost: (1 &lt;= 1.xxx * 1.xxx &lt; 4)</p>
<p>But it is still revelant, and trailing bits can be lost, as seen in the example here.</p>
<p>Note however that multiplication of the exponent 2^{exp} is a pure integer operation and is a reversible operation, up to over/underflow. (It also just happens to also manipulate the {frac}).</p>
</aside>
</section>
<section id="sample-program" class="slide level2">
<h2>Sample program</h2>
<pre class="fortran"><code>program rounding
  use iso_fortran_env, only : real64
  implicit none

  real(kind=real64) :: a, b, c

  a = 1.5
  b = 1.5
  c = 1.0000000000000002_real64

  print &#39;(a, es23.17)&#39;, &quot;(a * b) * c = &quot;, (a * b) * c
  print &#39;(a, es23.17)&#39;, &quot;a * (b * c) = &quot;, a * (b * c)
end program rounding</code></pre>
</section></section>
<section id="integrity-of-parentheses" class="title-slide slide level1">
<h1>Integrity of parentheses</h1>
<p>V&amp;V requires integrity of parentheses</p>
<p>GCC Fortran</p>
<pre class="sh"><code>gfortran -fprotect-parens ...    # default
gfortran -Ofast ...              # Sets -fno-protect-parens</code></pre>
<p>Intel Fortran</p>
<pre class="sh"><code>ifort -assume protect-parens     # Not default</code></pre>
<p>Note: Ignoring parentheses is non-compliant! (J3/18-007r1, 10.1.5)</p>
</section>

<section id="parallel-summation" class="title-slide slide level1">
<h1>Parallel summation</h1>
<p>How to compute reproducible means or global sums?</p>
<ol type="1">
<li><p>Enforce ordering</p>
<p><span class="math display">\[\sum{\phi} = (\phi_1 + (\phi_2 + ( \phi_3 + ... )))\]</span></p></li>
<li><p>Fixed-precision arithmetic</p>
<p><a href="https://doi.org/10.1016/j.parco.2014.04.007"><img data-src="img/fixedprec.svg" alt="image" /></a></p></li>
</ol>
</section>

<section id="associative-scaling" class="title-slide slide level1">
<h1>Associative Scaling</h1>
<p>Recall the floating point format:</p>
<p><span class="math display">\[\phi \equiv (-1)^s \times 2^M \times  (1 + \alpha)\]</span></p>
<p>Power-of-two multiplication is associative:</p>
<p><span class="math display">\[2^N \times \phi \times 2^{-N} \equiv \phi\]</span></p>
</section>

<section id="dimension-scaling" class="title-slide slide level1">
<h1>Dimension Scaling</h1>
<p>Rescale quantities by dimensions should be invariant:</p>
<p><span class="math display">\[\begin{aligned}
u^{n+1} &amp;= u^{n} +  \Delta t \times \mathcal{F} \\
{\color{yellow}2^{L-T}} u^{n+1} &amp;= {\color{yellow}2^{L-T}} u^{n}
   + {\color{yellow}2^T} \Delta t
   \times {\color{yellow}2^{L - 2T}} \mathcal{F}
\end{aligned}\]</span></p>
</section>

<section id="dimensional-factors" class="title-slide slide level1">
<h1>Dimensional factors</h1>
<table>
<thead>
<tr class="header">
<th>Unit</th>
<th>Scaling</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>s</td>
<td>T</td>
<td>Time</td>
</tr>
<tr class="even">
<td>m</td>
<td>L</td>
<td>Horizontal length</td>
</tr>
<tr class="odd">
<td>m</td>
<td>H</td>
<td>Layer thickness</td>
</tr>
<tr class="even">
<td>m</td>
<td>Z</td>
<td>Vertical length</td>
</tr>
<tr class="odd">
<td>kg/m3</td>
<td>R</td>
<td>Density</td>
</tr>
<tr class="even">
<td>J/kg</td>
<td>Q</td>
<td>Enthalpy</td>
</tr>
</tbody>
</table>
<aside class="notes">
<p>The currently tracked units are shown in this table.</p>
<p>Enthalpy is the fundamental</p>
</aside>
</section>

<section id="rotational-invariance" class="title-slide slide level1">
<h1>Rotational Invariance</h1>
<p>Solutions must be invariant to <strong>index rotation</strong>, e.g.:</p>
<p><span class="math display">\[\phi(i&#39;,j&#39;) = \phi(j, N-i)\]</span></p>
<p>Both <em>fields</em> and <em>coordinates</em> are remapped.</p>
<p>Note: <span class="math inline">\(u\)</span> and <span class="math inline">\(v\)</span> are velocities along <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span>!</p>
</section>

<section id="index-rotation" class="title-slide slide level1">
<h1>Index Rotation</h1>
<table>
<tbody>
<tr class="odd">
<td><img data-src="img/rotate_grid1.svg" style="width:70.0%" alt="image" /></td>
<td><img data-src="img/rotate_grid2.svg" style="width:70.0%" alt="image" /></td>
</tr>
</tbody>
</table>
<p><img data-src="img/rotate_mem.svg" style="width:65.0%" alt="image" /></p>
<aside class="notes">
<p>I call it an "index rotation" here since there is no physical rotation of the system here.</p>
<p>No physical rotation is ever applied to the system, neither the fields themselves nor the coordinates.</p>
<p>What is being rotated is the index map of the fields.</p>
<p>Everything here is rotated: the fields, the topographies, the forcings, even the coordinates. The net result is nothing is r</p>
</aside>
</section>

<section id="invariant-stencils" class="title-slide slide level1">
<h1>Invariant stencils</h1>
<p><span class="math inline">\(\phi^{(c)}_{i,j} = \frac{1}{4} (\phi_a + \phi_b + \phi_c + \phi_d)\)</span></p>
<p><img data-src="img/stencil.svg" class="float float" alt="image" /></p>
<table>
<tbody>
<tr class="odd">
<td><img data-src="img/stencil1.svg" alt="image" /></td>
<td><span class="math inline">\(\frac{1}{4} ( (\phi_A + \phi_B) + (\phi_C + \phi_D) )\)</span></td>
</tr>
<tr class="even">
<td><img data-src="img/stencil2.svg" alt="image" /></td>
<td><span class="math inline">\(\frac{1}{4} ( (\phi_A + \phi_D) + (\phi_B + \phi_C) )\)</span></td>
</tr>
</tbody>
</table>
<aside class="notes">
<p>The ideal outcome is to construct the stencil in a rotationally invariant form.</p>
<p>The first example will evaluate its terms in a different order after a quarter turn.</p>
<p>The second form is rotationally invariant to any number of quarter turns.</p>
</aside>
</section>

<section id="rotational-ordering" class="title-slide slide level1">
<h1>Rotational ordering</h1>
<p>When all else fails, reorder the algorithm:</p>
<pre class="fortran"><code>subroutine advect_tracer(...)
   ! ...
   x_first = modulo(turns, 2) == 1
   if (x_first) then
      call advect_x(...)
      call advect_y(...)
   else
      call advect_y(...)
      call advect_x(...)
   endif
end subroutine advect_tracer</code></pre>
</section>

<section id="negative-zero" class="title-slide slide level1">
<h1>Negative zero?</h1>
<p>TODO?</p>
</section>

<section id="solution-verification" class="title-slide slide level1">
<h1>Solution verification</h1>
<p><code>ocean.stats</code>:</p>
<pre><code>Step,       Day,  Truncs,      Energy/Mass,      Maximum CFL,  Mean Sea Level,  Total Mass,  Mean Salin, Mean Temp, Frac Mass Err,   Salin Err,    Temp Err
          [days]                 [m2 s-2]           [Nondim]       [m]             [kg]         [PSU]      [degC]       [Nondim]        [PSU]        [degC]
   0,       0.000,     0, En 7.2161166068132286E-27, CFL  0.00000, SL  1.8190E-12, M 1.39637E+20, S 35.0000, T 13.3483, Me  0.00E+00, Se  0.00E+00, Te  0.00E+00
  12,       0.500,     0, En 2.7781004671136538E-04, CFL  0.00011, SL  1.1369E-12, M 1.39637E+20, S 35.0000, T 13.3484, Me -6.09E-17, Se -3.90E-15, Te -1.17E-15
  24,       1.000,     0, En 2.7734897826598717E-04, CFL  0.00014, SL  1.8190E-12, M 1.39637E+20, S 35.0000, T 13.3486, Me  2.89E-17, Se  8.80E-17, Te -2.88E-16</code></pre>
<p>Solution regressions are detected in total energy, mass, etc.</p>
</section>

<section id="diagnostic-verification" class="title-slide slide level1">
<h1>Diagnostic verification</h1>
<p><code>chksum_diag</code>:</p>
<pre><code>u-point: mean=   1.1239682303793666E-04 min=  -6.7187595818683776E-03 max=   3.3480219779204019E-02 ocean_model-u
u-point: c=     21851 ocean_model-u
 column: mean=   1.2142284359736260E-04 min=  -3.3825897670462635E-06 max=   7.9266878285473325E-04 ocean_model-u_xyave
 column: c=       276 ocean_model-u_xyave
u-point: mean=   3.6442721276962604E-04 min=  -6.7187595818683776E-03 max=   3.3480219779204019E-02 ocean_model_z-u
u-point: c=     84323 ocean_model_z-u
 column: mean=   3.7252883050797810E-04 min=  -2.3761877018668929E-05 max=   7.9266878285473325E-04 ocean_model_z-u_xyave
 column: c=      1098 ocean_model_z-u_xyave
v-point: mean=   1.2076392816784489E-03 min=  -8.3469699425156359E-03 max=   6.8420831486068704E-03 ocean_model-v
v-point: c=     18606 ocean_model-v
 column: mean=   1.6305167686279899E-03 min=   1.3060287257008845E-03 max=   1.7892395238934757E-03 ocean_model-v_xyave
 column: c=       275 ocean_model-v_xyave
v-point: mean=   1.4290723910598869E-03 min=  -8.3469699425156359E-03 max=   6.8420831486068704E-03 ocean_model_z-v
v-point: c=     72299 ocean_model_z-v
 column: mean=   1.7194255440632058E-03 min=   1.3060344422280463E-03 max=   1.7948242423318677E-03 ocean_model_z-v_xyave
 column: c=      1115 ocean_model_z-v_xyave
h-point: mean=   3.6490088139048595E+02 min=   9.9999999999999915E-04 max=   5.6265092225099863E+02 ocean_model-h
h-point: c=     18673 ocean_model-h
 column: mean=   3.6810471584836824E+02 min=   1.2203636793942378E+02 max=   5.6250059062408047E+02 ocean_model-h_xyave
 column: c=       218 ocean_model-h_xyave
h-point: mean=   9.4167969391093152E+01 min=   0.0000000000000000E+00 max=   5.0005664888815596E+02 ocean_model_z-h
h-point: c=     63170 ocean_model_z-h
 column: mean=   1.3164426874862630E+02 min=   5.0000065780216882E+00 max=   5.0000001162626262E+02 ocean_model_z-h_xyave
 column: c=       847 ocean_model_z-h_xyave
h-point: mean=  -1.7380330739934577E+03 min=  -4.4154552337742143E+03 max=   4.2186301382082547E-01 ocean_model-e
h-point: c=     20756 ocean_model-e
 column: mean=  -1.7489127457746706E+03 min=  -2.9448377267869464E+03 max=  -2.5739527589596594E-13 ocean_model-e_xyave
 column: c=       250 ocean_model-e_xyave
h-point: mean=  -7.3645997170533087E+02 min=  -4.4154552337742143E+03 max=   4.2186301382082547E-01 ocean_model_z-e
h-point: c=     62532 ocean_model_z-e
 column: mean=  -7.4335128058531780E+02 min=  -2.0367396644260416E+03 max=  -2.5739527589596594E-13 ocean_model_z-e_xyave
 column: c=       830 ocean_model_z-e_xyave</code></pre>
<p>Record min, max, mean, and bitcount for every diagnostic.</p>
</section>

<section>
<section id="testing-results" class="title-slide slide level1">
<h1>Testing Results</h1>
<p>Over 40 issues and bugs have been detected and fixed:</p>
<p>TODO:</p>
<ul>
<li>Move these examples to the test descriptions</li>
<li>Move the "over 40 bugs" comment to the conclusions</li>
</ul>
</section>
<section id="dimensional-scaling-example" class="slide level2">
<h2>Dimensional scaling example</h2>
<p><a href="https://github.com/NOAA-GFDL/MOM6/pull/921">https://github.com/NOAA-GFDL/MOM6/pull/921</a></p>
<pre class="fortran"><code>Kd_lay(i,j,k-1) = Kd_lay(i,j,k-1) + 0.5**KS_extra(i,K)
Kd_lay(i,j,k)   = Kd_lay(i,j,k)   + 0.5**KS_extra(i,K)</code></pre>
<p><span class="math inline">\(\ldots + \left(\tfrac{1}{2}\right)^{\kappa_S}\)</span>?</p>
<aside class="notes">
<p>Actually discovered during implementation of the dimensional scaling, rather than detected by the dimensional scaling test. But it's the sort of thing that would have been found...</p>
</aside>
</section>
<section id="rotational-example" class="slide level2">
<h2>Rotational example</h2>
<p><a href="https://github.com/NOAA-GFDL/MOM6/pull/1050">https://github.com/NOAA-GFDL/MOM6/pull/1050</a></p>
<pre class="fortran"><code>subroutine thickness_diffuse_full
   !...
   Work_u(I,j) = Work_u(I,j) + G_scale * (...)
   Work_v(i,J) = Work_v(i,J) - G_scale * (...)
   !...
end subroutine thickness_diffuse_full</code></pre>
</section>
<section id="indexing-example" class="slide level2">
<h2>Indexing example</h2>
<p>Assumed 1-based start index</p>
<pre class="fortran"><code>subroutine register_time_deriv(...)
   real, dimension(:,:,:), target :: f_ptr
   real, dimension(:,:,:), target :: deriv_ptr
   ! ...
end subroutine register_time_deriv</code></pre>
<p>Fails for 0-based symmetric memory grids!</p>
</section>
<section id="another-indexing-example" class="slide level2">
<h2>Another indexing example</h2>
<p>78d2dc3ee9a018f30bc666bd574e21fb7786403d</p>
<p>Extended domain to accommodate symmetric grids:</p>
<pre class="fortran"><code>do J=js,je ; do i=is,ie
   h_vel = 0.5*((htot_fast(i,j) + htot_fast(i+1,j)) + h_neglect)
   uDml_diag(I,j) = uDml_diag(I,j) / (0.01*h_vel) * G%IdyCu(I,j) * (PSI(0.)-PSI(-.01))
enddo ; enddo</code></pre>
<pre class="fortran"><code>do J=js,je ; do i=is-1,ie
   h_vel = 0.5*((htot_fast(i,j) + htot_fast(i+1,j)) + h_neglect)
   uDml_diag(I,j) = uDml_diag(I,j) / (0.01*h_vel) * G%IdyCu(I,j) * (PSI(0.)-PSI(-.01))
enddo ; enddo</code></pre>
</section></section>
<section id="development-guidelines" class="title-slide slide level1">
<h1>Development Guidelines</h1>
<ol start="0" type="1">
<li>Verification must have bit reproducibility</li>
<li>Use parentheses!
<ol type="a">
<li>Are they honored?</li>
<li>Am I preserving residuals?</li>
</ol></li>
<li>Use <code>reproducing_sum()</code>
<ol type="a">
<li>Even better: Don't do global sums!</li>
</ol></li>
<li>Use rotationally invariant stencils</li>
</ol>
</section>
    </div>
  </div>

  <script src="./reveal.js/dist/reveal.js"></script>
  <script src="./reveal.js/plugin/math/math.js"></script>
  <script src="./reveal.js/plugin/notes/notes.js"></script>
  <script src="./reveal.js/plugin/highlight/highlight.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        // Display the page number of the current slide
        slideNumber: true,
        // Push each slide change to the browser history
        history: true,
        math: {
          mathjax: 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js',
          config: 'TeX-AMS_HTML-full',
          //TeX: {
          //  inlineMath: [['\\(','\\)']],
          //  displayMath: [['\\[','\\]']],
          //  balanceBraces: true,
          //  processEscapes: false,
          //  processRefs: true,
          //  processEnvironments: true,
          //  preview: 'TeX',
          //  skipTags: ['script','noscript','style','textarea','pre','code'],
          //  ignoreClass: 'tex2jax_ignore',
          //  processClass: 'tex2jax_process'
          //},
        },

        // Optional reveal.js plugins
        dependencies: [
          { src: './reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: './reveal.js/plugin/zoom-js/zoom.js', async: true },
          { src: './reveal.js/plugin/notes/notes.js', async: true }
        ],
        plugins : [ RevealMath, RevealNotes, RevealHighlight],
      });
    </script>
    </body>
</html>
